[[plugins]]
repo = "Shougo/ddu.vim"
depends = "denops.vim"
lua_add = """
local vimx = require("artemis")
local prefix = "<Plug>(ddu-prefix)"

vimx.keymap.set("n", "<C-p>", prefix)
vimx.keymap.set(
  "n",
  prefix .. "<C-p>",
  function()
    vimx.fn.ddu.start({
      ui = "ff",
      sources = { {
        name = "file_external",
        params = {
          cmd = {
            "fd",
            "--hidden",
            "--color",
            "never",
            "--type",
            "file",
            "--exclude",
            ".git",
          },
        }
      } }
    })
  end
)

vimx.keymap.set(
  "n",
  prefix .. "<C-w>",
  function()
    vimx.fn.ddu.start({
      ui = "ff",
      sources = { {
        name = "mr",
        params = { kind = "mrw" }
      } }
    })
  end
)

vimx.keymap.set(
  "n",
  prefix .. "<C-b>",
  function()
    vimx.fn.ddu.start({
      ui = "ff",
      sources = { {
        name = "buffer"
      } }
    })
  end
)

vimx.keymap.set(
  "n",
  prefix .. "<C-l>",
  function()
    vimx.fn.ddu.start({
      ui = "ff",
      sources = { {
        name = "rg",
        options = { marcher = {} }
      } },
      uiParams = {
        ff = { ignoreEmpty = false }
      },
      volatile = true,
    })
  end
)

vimx.keymap.set(
  "n",
  prefix .. "<C-t>",
  function()
    local id = vimx.fn.denops.callback.register(
      function(s)
        vimx.fn.sonictemplate.apply(s, "n")
      end,
      { once = true }
    )
    vimx.fn.ddu.start({
      sources = {
        {
          name = "custom-list",
          params = {
            texts = vimx.fn.sonictemplate.complete("", "", 0),
            callbackId = id,
          }
        }
      }
    })
  end
)

function grepWrapper(word)
  if word == "" then
    return
  end
  vimx.fn.ddu.start({
    ui = "ff",
    sources = { {
      name = "rg",
      params = { input = word },
    } },
    sourceOptions = {
      rg = { matchers = {
        'converter_display_word',
        'matcher_fzf',
      } }
    }
  })
end

vimx.create_command(
  "DduGrep",
  function(opts)
    grepWrapper(opts.args)
  end,
  { nargs = 1 }
)

vimx.keymap.set(
  "n",
  prefix .. "<C-g>",
  ":<C-u>DduGrep "
)

vimx.keymap.set(
  "n",
  prefix .. "g",
  function()
    grepWrapper(vimx.fn.expand("<cword>"))
  end
)
"""
lua_source = """
local vimx = require("artemis")

local config = {
  ui = "ff",
  sources = { {
    name = "file_rec",
    params = {
      ignoredDirectories = {
        ".git",
        "node_modules",
      }
    }
  }, {
    name = "file_external",
    params = {
      cmd = {
        "fd",
        "--hidden",
        "--color",
        "never",
        "--type",
        "file",
        "--exclude",
        [[.git]],
      },
    }
  } },
  sourceOptions = {
    _ = {
      ignoreCase = true,
      matchers = { "matcher_fzf" },
    },
  },
  sourceParams = {
    rg = {
      rg = {
        matchers = {
          "converter_display_word",
          "matcher_substring",
        }
      },
      args = {
        "--json",
        "--ignore-case",
      }
    },
    mru = {
      mr = {
        kind = "mru",
        current = true,
      }
    }
  },
  filterParams = {
    matcher_fzf = {
      highlightMathced = "Search",
    },
    matcher_substring = {
      highlightMathced = "Search",
    }
  },
  kindOptions = {
    file = {
      defaultAction = "open"
    },
    ["custom-list"] = {
      defaultAction = "callback",
    },
  },
  uiParams = {
    ff = {
      ignoreEmpty = true,
      split = "floating",
      filterSplitDirection = "floating",
      filterFloatingPosition = "top",
      prompt = ">",
      previewFloating = true,
      previewSplit = "vertical",
      -- autoAction = { name = "preview" },
      startFilter = true,
      floatingBorder = {
        "┌", "─", "┐", "│", "┘", "─", "└", "│",
      },
      previewFloatingBorder = {
        "┌", "─", "┐", "│", "┘", "─", "└", "│",
      },
    }
  }
}

local function reset_size()
  local win_col = math.floor(vimx.go.columns * 0.1)
  local win_width = math.floor(vimx.go.columns * 0.8)
  local win_row = math.floor(vimx.go.lines * 0.1)
  local win_height = math.floor(vimx.go.lines * 0.8)
  config.uiParams.ff.winCol = win_col
  config.uiParams.ff.winWidth = win_width
  config.uiParams.ff.winRow = win_row
  config.uiParams.ff.winHeight = win_height

  config.uiParams.ff.previewCol = math.floor(win_col - win_width * 0.5)
  config.uiParams.ff.previewWidth = math.floor(win_width * 0.5)
  config.uiParams.ff.previewRow = win_row
  config.uiParams.ff.previewheight = win_height
  vimx.fn.ddu.custom.patch_global(config)
end

reset_size()

local group = vimx.create_augroup("ddu-reset-size", { clear = true })
vimx.create_autocmd(
  "VimResized",
  {
    group = group,
    pattern = "*",
    callback = reset_size
  }
)
"""
on_func = ["ddu#start"]
on_map = { n = "<Plug>(ddu" }

[[plugins]]
repo = "Shougo/ddu-ui-ff"
on_source = "ddu.vim"
[plugins.ftplugin]
ddu-ff = """
setlocal cursorline
cnoreabbrev <buffer> q call ddu#ui#do_action('quit')
nnoremap <C-w><C-w> <C-w><C-w>

nnoremap <buffer><nowait> <CR> <Cmd>call ddu#ui#do_action('itemAction')<CR>
nnoremap <buffer><nowait> T <Cmd>call ddu#ui#do_action('itemAction', #{ name: 'open', params: #{ command: 'tabedit' } })<CR>
nnoremap <buffer><nowait> V <Cmd>call ddu#ui#do_action('itemAction', #{ name: 'open', params: #{ command: 'vsplit' } })<CR>
nnoremap <buffer><nowait> S <Cmd>call ddu#ui#do_action('itemAction', #{ name: 'open', params: #{ command: 'split' } })<CR>
nnoremap <buffer><nowait> Q <Cmd>call ddu#ui#do_action('itemACtion', #{ name: 'quickfix' })<CR>
nnoremap <buffer><nowait> <Space> <Cmd>call ddu#ui#do_action('toggleSelectItem')<CR>
nnoremap <buffer><nowait> p <Cmd>call ddu#ui#do_action('preview')<CR>
nnoremap <buffer><nowait> q <Cmd>call ddu#ui#do_action('quit')<CR>
"""
ddu-ff-filter = """
cnoreabbrev <buffer> q call ddu#ui#do_action('quit')
nnoremap <buffer><nowait> <C-w><C-w> <C-w><C-w>

inoremap <buffer><nowait> <CR> <Cmd>call ddu#ui#do_action('itemAction')<CR>
inoremap <buffer><nowait> <C-t> <Cmd>call ddu#ui#do_action('itemAction', #{ name: 'open', params: #{ command: 'tabedit' } })<CR>
inoremap <buffer><nowait> <C-v> <Cmd>call ddu#ui#do_action('itemAction', #{ name: 'open', params: #{ command: 'vsplit' } })<CR>
inoremap <buffer><nowait> <C-s> <Cmd>call ddu#ui#do_action('itemAction', #{ name: 'open', params: #{ command: 'split' } })<CR>
inoremap <buffer><nowait> <C-q> <Cmd>call ddu#ui#do_action('itemAction', #{ name: 'quickfix' })<CR>
inoremap <buffer><nowait> <Space> <Cmd>call ddu#ui#do_action('toggleSelectItem')<CR>
inoremap <buffer><nowait> <C-g> <Cmd>call ddu#ui#multi_actions([['clearSelectAllItems'], ['toggleAllItems'], ['itemAction', #{ name: 'quickfix' }]])<CR>
inoremap <buffer><nowait> <C-o> <Cmd>call ddu#ui#do_action('preview')<CR>
nnoremap <buffer><nowait> <CR> <Cmd>call ddu#ui#do_action('closeFilterWindow')<CR>

nnoremap <buffer><nowait> <C-n> <Cmd>call ddu#ui#ff#execute('call cursor(line(".")+1,0)<Bar>redraw')<CR>
nnoremap <buffer><nowait> <C-p> <Cmd>call ddu#ui#ff#execute('call cursor(line(".")-1,0)<Bar>redraw')<CR>
inoremap <buffer><nowait> <C-n> <Cmd>call ddu#ui#ff#execute('call cursor(line(".")+1,0)<Bar>redraw')<CR>
inoremap <buffer><nowait> <C-p> <Cmd>call ddu#ui#ff#execute('call cursor(line(".")-1,0)<Bar>redraw')<CR>
"""

[[plugins]]
repo = "Shougo/ddu-source-file_rec"
on_source = "ddu.vim"

[[plugins]]
repo = "shun/ddu-source-rg"
on_source = "ddu.vim"

[[plugins]]
repo = "kuuote/ddu-source-mr"
on_source = "ddu.vim"
depends = ["mr.vim"]

[[plugins]]
repo = "lambdalisue/mr.vim"
on_func = ["mr#mru#list", "mr#mrr#list", "mr#mrw#list"]

[[plugins]]
repo = "shun/ddu-source-buffer"
on_source = "ddu.vim"

[[plugins]]
repo = "liquidz/ddu-source-custom-list"
on_source = "ddu.vim"

[[plugins]]
repo = "matsui54/ddu-source-file_external"
on_source = "ddu.vim"

[[plugins]]
repo = "Shougo/ddu-filter-converter_display_word"
on_source = "ddu.vim"

[[plugins]]
repo = "Shougo/ddu-filter-matcher_substring"
on_source = "ddu.vim"

[[plugins]]
repo = "yuki-yano/ddu-filter-fzf"
on_source = "ddu.vim"

[[plugins]]
repo = "Shougo/ddu-kind-file"
on_source = "ddu.vim"

# [[plugins]]
# repo = "lambdalisue/kensaku.vim"
# depends = ["denops.vim"]
# on_source = "denops.vim"
